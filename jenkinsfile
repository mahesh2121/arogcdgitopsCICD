pipeline{
   agent any

   environment {
      
      DOCKERHUB_USERNAME = "maheshgaikwad21"
      APP_NAME = "gitops_argocd-app"
      IMAGE_TAG = "${BUILD_NUMBER}"
      IMAGE_NAME = "${DOCKERHUB_USERNAME}" + "/" + "${APP_NAME}"
      REGISTRY_CRDS = 'dockerhub'    
   }
   stages{

      stage('Clenup workspace'){

          steps{

              script{

                  cleanWs()
              }
           }
      } 
      stage('Checkout SCM') {
          steps{

              script{

                  git credentialsId: 'github',
                  url: 'https://github.com/mahesh2121/arogcdgitopsCICD.git' ,
                  branch: 'main'
              }
          }
      }
      stage('Build Docker Image') {
          steps{

              script{

                  docker_image = docker.build "${IMAGE_NAME}"
              }
          }
      }
      stage('Push Docker Image') {
          steps{

              script{
                  docker.withRegistry('',REGISTRY_CRDS){
                  docker_image.push("$BUILD_NUMBER")
                  docker_image.push('latest')
                  }
              }
          }
      }
      stage('remove Docker Image') {
          steps{

              script{
                  sh "docker rmi ${IMAGE_NAME}:${IMAGE_TAG}"
                  sh "docker rmi ${IMAGE_NAME}:latest" 
                  }
              }
      }
      stage('update kubernetes deployement') {
          steps{

              script{
                  sh """
                  cat deployement.yml
                  sed -i 's/${APP_NAME}.*/${APP_NAME}:${IMAGE_TAG}/g' deployement.yml
                  """
                  cat deployement.yml
              }                   
          }
      }
   }
}

